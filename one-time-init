#!/bin/sh

# Determine the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
SECRETS_DIR="$SCRIPT_DIR/modules/home/secrets"

# Configuration
KEY_FILE="$SECRETS_DIR/keys.txt"
AGE_FILE="$SECRETS_DIR/keys.txt.age"

# Color definitions (ANSI escape codes)
GREEN='\033[0;32m'
YELLOW_BOLD='\033[1;33m'
CYAN='\033[0;36m'
RED_BOLD='\033[1;31m'
NC='\033[0m' # No Color

# Check if the key already exists
if [ -f "$KEY_FILE" ]; then
  printf "${GREEN}âœ“ Master key already exists at $KEY_FILE${NC}\n"
  exit 0
fi

# If we are here, the file is missing
printf "${YELLOW_BOLD}ðŸ”’ Master key not found!${NC}\n"

echo "We need to decrypt the master key to unlock your secrets."
echo

printf "${CYAN}Please enter your passphrase when prompted by ${YELLOW_BOLD}age${CYAN}...${NC}\n"

# Ensure the directory exists
mkdir -p "$SECRETS_DIR"

# Run age via nix run
# We use '--' to separate nix flags from age flags
nix --extra-experimental-features "nix-command flakes" run nixpkgs#age -- -d -o "$KEY_FILE" "$AGE_FILE"

# Check if it worked (check exit code of previous command)
if [ $? -eq 0 ]; then
  echo
  printf "${GREEN}âœ“ Successfully decrypted keys.txt!${NC}\n"

  # Set permissions strictly just in case
  chmod 600 "$KEY_FILE"
else
  echo
  printf "${RED_BOLD}âœ— Decryption failed.${NC}\n"
  echo "Please check your passphrase and try again."
  exit 1
fi
